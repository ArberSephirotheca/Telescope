# Fragment used by the two variants of the Developers query to get user info.
fragment UserInfo on users {
    username
    first_name
    last_name
    role

    # RCS ID if available
    rcs_id: user_accounts(where: {type: {_eq: "rpi"}}) {
        account_id
    }


    # Are they a coordinator in an ongoing semester
    is_coordinating: enrollments(
        where: {
            semester: {
                start_date: {_lte: $now}
                end_date: {_gte: $now}
            },
            is_coordinator: {_eq: true}
        }
    ) {
        semester {
            title
        }
    }

    # What small groups does this user currently mentor?
    current_mentoring: small_group_mentors(
        where: {small_group: {semester: {
            start_date: {_lte: $now}
            end_date: {_gte: $now}
        }}}
    ) {
        small_group {
            title
        }
    }

}

# Developers Page Query
query Developers(
    $limit: Int!,
    $offset: Int!,
    $search: String!,
    $now: date!,
    $include_old: Boolean!
) {
    # All users (this field will be available if old users are included.)
    all_users: users(
        # Get users in groups of 20.
        limit: $limit,
        offset: $offset,
        where: {
            _or: {
                first_name: {_ilike: $search},
                last_name: {_ilike: $search},
                username: {_ilike: $search}
            }
        },
        order_by: [{first_name: asc}, {last_name: asc}]
    ) @include(if: $include_old) {
        ...UserInfo
    }

    # Current users (if include_old is false)
    current_users: users(
        # Get users in groups of 20
        limit: $limit,
        offset: $offset,
        where: {
            enrollments: {semester: {
                start_date: {_lte: $now}
                end_date: {_gte: $now}
            }},
            _or: {
                first_name: {_ilike: $search}
                last_name: {_ilike: $search}
                username: {_ilike: $search}
            }
        }
    ) @skip(if: $include_old) {
        ... UserInfo
    }
}
